<html>
<head>
<script>
// 82.41 Hz is an E note.
navigator.webkitGetUserMedia({ "audio": true }, use_stream, function() {});
var audio_context;
var analyzer;
function use_stream(stream)
{
	audio_context = new AudioContext();
	var stream_source = audio_context.createMediaStreamSource(stream);
	analyzer = audio_context.createAnalyser();
	stream_source.connect(analyzer);
}

window.addEventListener
(
	"load",
	function()
	{
		document.getElementById("capture").addEventListener("click", function() { get_time_series(analyzer); });
	}
);

function get_time_series(analyzer)
{
	var buffers = new Uint8Array(analyzer.fftSize);
	analyzer.getByteTimeDomainData(buffer);

	var frequency_amplitudes = fourier_transform(buffer);
	// Skip the zero-frequency mode, which always has a huge amplitude.
	var magnitudes = frequency_amplitudes.slice(1).map(function(z) { return z[0] * z[0] + z[1] * z[1]; });
	//console.log(magnitudes);

	var average = magnitudes.reduce(function(a, b) { return a + b; }, 0) / magnitudes.length;
	var maximum_index = -1;
	var maximum_magnitude = 0;
	for (var i = 0; i < magnitudes.length; i++)
	{
		if (magnitudes[i] <= maximum_magnitude)
			continue;

		maximum_index = i;
		maximum_magnitude = magnitudes[i];
	}

	var dominant_frequency = maximum_index * analyzer.context.sampleRate / analyzer.fftSize;
	console.log("dominant frequency appears to be %f", dominant_frequency);
	var semitones_up = 12 * Math.log(dominant_frequency / 82.41) / Math.log(2);
	console.log("%f semitones above E (82.41 Hz)", semitones_up);
}

function fourier_transform(time_series)
{
	var scale_factor = 2 * Math.PI / time_series.length;
	var amplitudes = [];
	for (var k = 0; k < 20; k++)
	{
		var accumulator = [ 0, 0 ];
		for (var t = 0; t < time_series.length; t++)
		{
			accumulator[0] += time_series[t] * Math.cos(scale_factor * k * t);
			accumulator[1] += time_series[t] * Math.sin(scale_factor * k * t);
		}

		amplitudes.push(accumulator);
	}

	return amplitudes;
}
</script>
</head>

<body>
<button id="capture">capture</button>
<br><br>
<div id="visualization">
</div>
</body>
</html>
