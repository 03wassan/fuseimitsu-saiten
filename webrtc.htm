<html>
<head>
<script>
// 82.41 Hz is an E note.
window.addEventListener
(
	"load",
	function()
	{
		navigator.webkitGetUserMedia({ "audio": true }, use_stream, function() {});

		var recording_timer;
		var fourier_worker = new Worker("fft.js");
		var sample_length_milliseconds = 200;
		var audio_context = new AudioContext();
		function use_stream(stream)
		{
			var microphone = audio_context.createMediaStreamSource(stream);
			var script_processor = audio_context.createScriptProcessor(256, 1, 1);

			var buffer = [];
			var recording = false;
			function capture_audio(event)
			{
				if (!recording)
					return;

				buffer = buffer.concat(Array.prototype.slice.call(event.inputBuffer.getChannelData(0)));

				// Stop recording after sample_length_milliseconds.
				if (buffer.length > sample_length_milliseconds * audio_context.sampleRate / 1000)
				{
					recording = false;
					fourier_worker.postMessage(buffer);
					buffer = [];
				}
			};

			script_processor.onaudioprocess = capture_audio;
			script_processor.connect(audio_context.destination);
			microphone.connect(script_processor);

			recording_timer = setInterval(function() { recording = true; }, 500);
		}

		document.getElementById("stop").addEventListener
		(
			"click",
			function() { clearInterval(recording_timer); }
		);

		fourier_worker.addEventListener("message", interpret_fourier_result);

		var e_note = 82.41; // Hz
		var notes = [ "E", "F", "F#", "G", "G#", "A", "A#", "B", "C", "C#", "D", "D#" ];
		function interpret_fourier_result(event)
		{
			var time_series = event.data.time_series;
			var frequency_amplitudes = event.data.frequency_amplitudes;
			// Skip the zero-frequency mode, which always has a huge amplitude.
			var magnitudes = frequency_amplitudes.slice(1).map(function(z) { return z[0] * z[0] + z[1] * z[1]; });
			//console.log(magnitudes);

			var average = magnitudes.reduce(function(a, b) { return a + b; }, 0) / magnitudes.length;
			var maximum_index = -1;
			var maximum_magnitude = 0;
			for (var i = 0; i < magnitudes.length; i++)
			{
				if (magnitudes[i] <= maximum_magnitude)
					continue;

				maximum_index = i;
				maximum_magnitude = magnitudes[i];
			}

			// Adding one to the index because we cut off the zero-frequency mode.
			var dominant_frequency = (maximum_index + 1) * audio_context.sampleRate / time_series.length;
			var semitones_up = 12 * Math.log(dominant_frequency / e_note) / Math.log(2);

			var note_index = Math.round(semitones_up) % 12;
			if (note_index < 0)
				note_index += 12;

			var note_name = notes[note_index];
			var closest_named_frequency = e_note * Math.pow(2, Math.round(semitones_up) / 12);
			console.log("%s. peak/average = %f. freq = %f, closest to %f", note_name, maximum_magnitude / average, dominant_frequency, closest_named_frequency);
		}
	}
);
</script>
</head>

<body>
<button id="stop">stop</button>
</body>
</html>
